version: '3.3'

networks:
  isolation-network:
    driver: bridge


services:
  healthcheck:
    image: gherkin-test-execution
    network_mode: "host"
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    tty: true
    healthcheck:
      test: ["CMD", "sh", "docker/example-healthcheck.sh"]
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 1s

  # Local test execution does not export values to external storrage
  gherkin-test-local:
    image: gherkin-test-execution
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    command: run_tests
    environment:
      - RESULT_NAME=${RESULT_NAME:-example_result}
    volumes:
      - ./tests_result/:/app/results
    network_mode: "host"

  # Local test execution does not export values to external storrage
  gherkin-test-export:
    image: gherkin-test-execution
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    command: export_results
    environment:
      - RESULT_NAME=${RESULT_NAME:-example_result}
      - EXPORT_RESULTS=${EXPORT_SCRIPT:-docker/export_to_mongo.sh}
      - API_URL=${API_URL:-localhost:3333/healthcheck}
    volumes:
      - ./tests_result/:/app/results
    network_mode: "host"

volumes:
  test_result: